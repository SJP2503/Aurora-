name: Auto Scrape â€“ Aurora Data Pipeline

on:
  schedule:
    - cron: '0 1 * * *'   # run daily at 01:00 UTC
  workflow_dispatch:       # allows manual trigger with "Run workflow" button

jobs:
  scrape-all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare folders
        run: |
          mkdir -p data/input data/coa data/procurement data/comelec data/courts data/dbm saln_meta tools

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::rvest
            any::dplyr
            any::stringr
            any::janitor
            any::readr
            any::purrr
            any::jsonlite
            any::digest
            any::httr
            any::lubridate
          needs: |
            R/fetch_ph_legislators.R
            R/fetch_saln_metadata.R
            R/fetch_pnp_data.R
            R/coa_findings.R
            R/philgeps_awards.R
            R/comelec_soce.R
            R/court_cases.R
            R/dbm_releases.R

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pydantic

      # ---------- RUN SCRAPERS ----------
      - name: Run legislator scraper (House + Senate)
        run: Rscript R/fetch_ph_legislators.R

      - name: Build SALN metadata
        run: Rscript R/fetch_saln_metadata.R

      - name: Run PNP scraper
        run: Rscript R/fetch_pnp_data.R

      - name: Run COA findings scraper
        run: Rscript R/coa_findings.R

      - name: Run PhilGEPS awards normalizer
        run: Rscript R/philgeps_awards.R

      - name: Run COMELEC SOCE normalizer
        run: Rscript R/comelec_soce.R

      - name: Run Courts case extractor
        run: Rscript R/court_cases.R

      - name: Run DBM releases normalizer
        run: Rscript R/dbm_releases.R

      # ---------- POST RISK EVENTS ----------
      - name: Emit risk events to Aurora
        env:
          AURORA_API_URL: ${{ secrets.AURORA_API_URL }}
          AURORA_API_TOKEN: ${{ secrets.AURORA_API_TOKEN }}
        run: |
          python tools/emit_risk.py

      # ---------- COMMIT OUTPUTS ----------
      - name: Commit & push data
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions"
          git add data/*.csv data/*/*.csv saln_meta/*.json || true
          git commit -m "[auto] Update data (Legislators/SALN/PNP/COA/PhilGEPS/COMELEC/Courts/DBM)" || echo "No changes to commit"
          git push

      # Debug info on failure
      - name: Session info on failure
        if: failure()
        run: |
          Rscript -e 'sessionInfo()'
          echo "--- repo tree ---"
          ls -R
